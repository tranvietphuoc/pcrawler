version: "3.8"

services:
  redis:
    image: redis:7-alpine
    container_name: crawler_redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - abenla_shared
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 1G

  worker:
    build: .
    command: celery -A app.tasks.tasks worker --loglevel=info --hostname=worker@%h --pool=solo --concurrency=1 --prefetch-multiplier=1 --max-memory-per-child=1500000 --max-tasks-per-child=20
    environment:
      - CELERY_WORKER_CONCURRENCY=1
      - CELERY_WORKER_PREFETCH_MULTIPLIER=1
      - CELERY_WORKER_MAX_TASKS_PER_CHILD=20
      - CELERY_WORKER_MAX_MEMORY_PER_CHILD=1500000
      - REDIS_URL=redis://redis:6379/0
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - TZ=Asia/Ho_Chi_Minh
      - C_FORCE_ROOT=1
    volumes:
      - ./app:/app/app
      - ./config:/app/config
      - ./data:/app/data
      - /tmp/playwright_workers:/tmp/playwright_workers
      - /tmp/crawl4ai_workers:/tmp/crawl4ai_workers
    depends_on:
      - redis
    networks:
      - abenla_shared
    deploy:
      resources:
        limits:
          cpus: "3.0"
          memory: 4G
        reservations:
          cpus: "2.0"
          memory: 3G
    restart: unless-stopped

  crawler_app:
    build: .
    container_name: cralwer_app
    command: tail -f /dev/null
    environment:
      - REDIS_URL=redis://redis:6379/0
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    volumes:
      - ./app:/app/app
      - ./config:/app/config
      - ./data:/app/data
    depends_on:
      - redis
      - worker
    networks:
      - abenla_shared
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "1.0"
          memory: 1G
    restart: unless-stopped

volumes:
  redis_data:

networks:
  abenla_shared:
    external: true
    name: abenla_shared
